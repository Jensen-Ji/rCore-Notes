# 什么是操作系统

图例示意：
红色：代表 硬件/物理层
蓝色：代表 内核态/OS
绿色：代表 用户态/App

## 1. 操作系统

操作系统是软件，帮助用户和应用程序使用和管理计算机资源
![ch0-001.excalidraw](ch0-001.excalidraw.md)

操作系统对用户是不可见的，但是它控制其他各种计算机系统
![ch0-002.excalidraw](ch0-002.excalidraw.md)

## 2. 系统软件

系统软件包括操作系统内核、驱动程序、工具软件、用户界面、软件库等
操作系统内核是核心，负责控制硬件资源并为用户和应用程序提供服务
驱动程序用于控制硬件设备，一般情况下，**驱动程序是操作系统内核的一部分**
工具软件用于维护、调试和优化计算机系统
用户界面用来帮助用户使用操作系统
软件库提供系统调用的接口
![ch0-003.excalidraw](ch0-003.excalidraw.md)

在微内核架构中，驱动独立与内核之外
在宏内核架构中，驱动包含在内核里面，或者作为模块加载进内核

## 3. 执行环境

在应用程序的角度：

执行环境提供运行应用软件所需要的运行时服务
包括：内存管理、文件系统访问、网络连接等，这些服务多数都由操作系统提供

简化了操作系统的概念：**操作系统就是应用程序的软件执行环境。**
软件在执行时，需要什么，操作系统就提供什么，也就是软件的执行环境。

ABI：
为什么是Binary，因为应用程序运行时，已经编译好了，是exe等形式，不是源码
所以和应用程序沟通，不能使用API，也就是函数名
需要使用寄存器、机器码指令等
通过编译器把API变成ABI

狭义的操作系统：操作系统内核
广义的操作系统：内核+库+GUI+工具等

![ch0-004.excalidraw](ch0-004.excalidraw.md)

一般情况下，APP通过API调用库，库通过ABI调用内核
在这里，APP通过ABI直接调用内核，也是rCore第一章要完成的

**执行环境 = System Software + Hardware** 或者 **执行环境 = OS + Hardware**
本质上，执行环境就是程序运行所需要的全套服务。硬件+软件只是物理层面的概括。

## 4. 操作系统的定义和组成

![ch0-005.excalidraw](ch0-005.excalidraw.md)
操作系统是向上为应用程序提供服务，向下管理硬件资源

操作系统怎么和硬件打交道，怎么提供服务?

操作系统主要组成：
- 操作系统内核
- 系统工具和软件库
- 用户接口

操作系统内核包括：
- 进程线程管理
- 内存管理
- 文件系统
- 网络通信
- 设备驱动
- 同步互斥
- 系统调用接口

这些也是rCore这本书讲述的重点

# 操作系统的系统调用

## 1. API 和 ABI

>操作系统与运行在用户态软件之间的接口形式就是上一节提到的应用程序二进制接口 ABI。

为这里是ABI而不是API
API是**源码**层面的约定，通常用于APP内部或者APP和库之间的调用。
ABI是**机器码/硬件**层面的约定，是APP和内核之间沟通的方式。
因为软件在用户态，操作系统是内核态。跨层面的沟通需要使用ABI。

>系统调用接口通常面向应用程序提供了 API 的描述，但在具体实现上，还需要提供 ABI 的接口描述规范

人话：系统调用接口就是给程序员提供一个API接口，但是API接口的实现，实则是ABI接口的实现。

操作系统提供了SCI接口，以API的形式在程序中被调用，然后实际执行的是ABI的功能。

# 操作系统抽象

## 1. 执行环境

>执行环境 (Execution Environment) 是一个内涵很丰富且有一定变化的术语，它主要负责给在其上执行的软件提供相应的功能与资源，并可在计算机系统中形成多层次的执行环境。

对于裸机硬件上的操作系统，操作系统的执行环境就是计算机硬件。
应用程序通过访问函数库来完成功能，应用程序的执行环境就是函数库。函数库的执行环境还是计算机硬件。

执行环境是分层的，谁在我的下面，谁就是我的执行环境。

// todo 画图

>CPU在执行过程中，可以在不同层次的执行环境之间切换，这称为 **执行环境切换**，执行环境切换通过调用API或ABI完成。

就是每层都是“自以为独立的”，通过接口切换。

>**应用程序的执行环境一个基本的定义**：执行环境是应用程序正确运行所需的服务与管理环境，用来完成应用程序在运行时的数据与资源管理、应用程序的生存期等方面的处理，它定义了应用程序有权访问的其他数据或资源，并决定了应用程序的行为限制范围。

总结：应用程序 依赖于 它的执行环境提供的接口来运行。

并不是：应用程序的执行环境就是接口，这是错误的。

### 1. 普通控制流

>在应用程序视角下，普通控制流只能接触到它所在的执行环境，不会跳到其他执行环境，所以应用程序执行基本上是以普通控制流的形式完成整个运行的过程。

控制流：CPU执行指令的顺序。
好比看小说，看的时候是第一行、第二行，看的顺序。

普通控制流：程序按部就班的执行代码，一切都在程序员的掌握之中。

### 2. 异常控制流

异常控制流：应用程序执行过程中，因为各种原因，出现前一条代码还在应用程序代码段，下一条代码就出现在了操作系统的代码段，位于完全不同的位置，也就是不同的执行环境中。这种控制流脱离了所在的执行环境，并且发生了执行环境的切换，就是异常控制流。

特征：瞬移、跨界

>应用程序 感知 不到这种异常的控制流情况，这主要是由于操作系统把这种情况 透明 地进行了执行环境的切换和对各种异常情况的处理，让应用程序从始至终地 认为 没有这些异常控制流的产生。

总结就是：异常控制流 导致了 执行环境的切换。
反过来：通过异常控制流，达到了切换执行环境的目的

### 3. 控制流上下文（执行环境的状态）

发生执行环境切换的时候，先把现在的环境状态保存到一块安全的内存上，然后切换执行环境，等执行完，再从安全的内存上把之前的环境状态取回来。

这个环境的状态就是控制流上下文，也就是CPU的寄存器快照。

函数调用是普通控制流，由编译器来保存上下文，在生成汇编时自动加上push/pop指令，无需程序员关心。
异常控制流是突变控制流，从APP跳到OS，由CPU和操作系统来保存上下文，必须由程序员编写汇编代码来保存。

>操作系统需要处理三种异常控制流：外设中断、陷入、异常。

### 4. 异常控制流：中断

>外设 中断 (Interrupt) 是指由外部设备引起的外部 I/O 事件，如时钟中断、控制台中断等。外设中断是异步产生的，与处理器的执行无关。

处理中断的流程：
中断触发跳转到指定地址，保存上下文，处理中断，恢复上下文。

### 5. 异常控制流：异常

>异常 (Exception) 是在处理器执行指令期间检测到不正常的或非法的内部事件（如 x86 平台上的除零错、地址访问越界）。

### 6. 异常控制流：陷入

>陷入 (Trap) 是程序在执行过程中由于要通过系统调用请求操作系统服务而有意引发的事件。

我的理解：我正在打游戏
中断：妈妈敲门喊我吃饭，被动的，是外部干扰
异常：电脑蓝屏了，被动的，是内部出错
陷入：段位打不上去，主动暂停，找人帮忙上分，是主动的，我请求服务

所以 陷入 就是应用程序主动找操作系统帮忙

## 2. 进程

进程是被加载到内存里、正在CPU上运行的程序。
操作系统会把运行程序需要的东西，都放进进程这个容器里。
进程是操作系统进行资源分配和调度的基本单位。

## 3. 地址空间

// todo

## 4. 文件

// todo

# 操作系统特征

// todo